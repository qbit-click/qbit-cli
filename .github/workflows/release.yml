name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: build-and-sign (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: linux
            binary_name: qbit-cli
            install_script: install.sh
            uninstall_script: uninstall.sh
          - os: macos-latest
            artifact: macos
            binary_name: qbit-cli
            install_script: install_macos.sh
            uninstall_script: uninstall_macos.sh
          - os: windows-latest
            artifact: windows
            binary_name: qbit-cli.exe
            install_script: install.ps1
            uninstall_script: uninstall.ps1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release

      - name: Sign binary (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        env:
          WINDOWS_CERT_PFX: ${{ secrets.WINDOWS_CERT_PFX }} # ðŸ“ Ø§ÛŒÙ†Ø¬Ø§ ÛŒÚ© cert Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª base64 Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        run: |
          if (-not $env:WINDOWS_CERT_PFX) { Write-Host "WINDOWS_CERT_PFX not set, skipping signing"; return }
          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_CERT_PFX))
          & "$env:ProgramFiles\Windows Kits\10\bin\x64\signtool.exe" sign `
            /f $pfxPath `
            /p $env:WINDOWS_CERT_PASSWORD `
            /tr http://timestamp.sectigo.com `
            /td sha256 `
            /fd sha256 `
            target\release\${{ matrix.binary_name }}

      - name: Sign binary (macOS)
        if: matrix.os == 'macos-latest'
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }} # ðŸ“ ÛŒÚ© ÙØ§ÛŒÙ„ p12 base64 Ø´Ø¯Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ÛŒØ¯.
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          MACOS_IDENTITY: ${{ secrets.MACOS_IDENTITY }} # Ù…Ø«Ù„Ø§: "Developer ID Application: Your Name (TEAMID)"
        run: |
          if [ -z "$MACOS_CERT_P12" ]; then
            echo "MACOS_CERT_P12 not set, skipping signing"
            exit 0
          fi
          CERT_PATH="$RUNNER_TEMP/cert.p12"
          echo "$MACOS_CERT_P12" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "" build.keychain
          security import "$CERT_PATH" -k build.keychain -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security unlock-keychain -p "" build.keychain
          /usr/bin/codesign --force --sign "$MACOS_IDENTITY" "target/release/${{ matrix.binary_name }}"

      - name: Sign binary (Linux, optional GPG)
        if: matrix.os == 'ubuntu-latest'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY not set, skipping signing"
            exit 0
          fi

          # import key
          echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import

          # allow loopback pinentry (required for GitHub Actions)
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

          # sign
          gpg --batch --yes \
            --pinentry-mode loopback \
            --passphrase "$GPG_PASSPHRASE" \
            --output target/release/${{ matrix.binary_name }}.sig \
            --detach-sign target/release/${{ matrix.binary_name }}
      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p dist
          cp target/release/${{ matrix.binary_name }} dist/
          if [ "${{ matrix.os }}" = "ubuntu-latest" ] && [ -f "target/release/${{ matrix.binary_name }}.sig" ]; then
            cp target/release/${{ matrix.binary_name }}.sig dist/
          fi
          cp "scripts/install/${{ matrix.install_script }}" dist/
          cp "scripts/install/${{ matrix.uninstall_script }}" dist/
          cp assets/icon.svg dist/
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            powershell Compress-Archive -Path dist\* -DestinationPath qbit-${{ matrix.artifact }}-setup.zip
          else
            tar -czf qbit-${{ matrix.artifact }}-setup.tar.gz -C dist .
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qbit-${{ matrix.artifact }}
          path: |
            qbit-${{ matrix.artifact }}-setup.zip
            qbit-${{ matrix.artifact }}-setup.tar.gz

  release:
    name: publish
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
